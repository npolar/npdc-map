#!/bin/bash
source="/mnt/datasets/api.npolar.no/_file/map/archive-tiff"
dest="/mnt/datasets/api.npolar.no/_file/map/archive"
i=0

function create_png {
  original=$1
  png=$2
  quality="00"
  
  if [[ ! -f $png ]] ; then
    mkdir -p `dirname "$png"`
    echo "[PNG] $png <- $original"
    `nice convert -quality $quality "$original" "$png"` # 2> /dev/null
  fi  
}

# Loop all TIFFs
find $source -type f -iname *.tif | while read filename 
do
  if [[ -f $filename ]] ; then
    
    i=$((i+1))
    echo "$filename [$i]"
    basename=`basename "$filename" .tif`
    basename=`basename "$basename" .TIF`
    
    dirname=`dirname "$filename" | sed -e 's/\(\-tiff\)*//g'`
  
    png="$dirname/$basename.png"
    png="${png// /_}"

    create_png "$filename" "$png"
  fi
done